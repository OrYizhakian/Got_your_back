<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with GeoCoder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #map-wrapper {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        #top-bar {
            height: 50px;
            width: 100%;
            background-color: #f4f4f4;
            line-height: 50px;
            text-align: center;
            border-bottom: 1px solid #ccc;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }

        #map {
            flex: 1;
            width: 100%;
        }
    </style>
</head>
<body>
<div id="map-wrapper">
    <!-- Top bar -->
    <div id="top-bar"></div>

    <!-- Map container -->
    <div id="map"></div>
</div>

<script>
    // Initialize the map
    const map = L.map('map').setView([32.0853, 34.7818], 15); // Center at Tel Aviv

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add GeoCoder control
    const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false // Prevent automatic marker placement

    })
    .on('markgeocode', function(e) {
        const { center } = e.geocode; // Get geocoded center coordinates
        L.marker(center).addTo(map) // Add marker at the location
            .bindPopup(`Coordinates: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`)
            .openPopup();
        map.setView(center, 15); // Center map on the selected location
        console.log(`Geocoded Location: Lat = ${center.lat}, Lng = ${center.lng}`);

        // Notify Android app with the selected coordinates
        if (window.Android && window.Android.sendCoordinates) {
            window.Android.sendCoordinates(center.lat, center.lng);
        }
    })
    .addTo(map);

    // Allow map size adjustment
    map.invalidateSize();

    // Enable click-to-add-marker functionality
    map.on('click', function(e) {
        const { lat, lng } = e.latlng;
        L.marker([lat, lng]).addTo(map)
            .bindPopup(`Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`)
            .openPopup();
    });

    // Search address function
function searchAddress(address) {
    console.log(`Received address to search: ${address}`); // Log the input address

    const geocoder = L.Control.Geocoder.nominatim(); // Initialize the geocoder
    geocoder.geocode(address, function(results) {
        console.log(`Geocoding results for "${address}":`, results); // Log the geocoding results

        if (results && results.length > 0) {
            const result = results[0];
            const { lat, lng } = result.center;

            console.log(`Geocoded location: Lat = ${lat}, Lng = ${lng}`); // Log the coordinates

            // Add marker to the map
            L.marker([lat, lng]).addTo(map)
                .bindPopup(`Found: ${address}`)
                .openPopup();
            map.setView([lat, lng], 15); // Center the map on the location

            // Send coordinates back to Android
            if (window.Android && window.Android.sendCoordinates) {
                console.log(`Sending coordinates to Android: Lat = ${lat}, Lng = ${lng}`);
                window.Android.sendCoordinates(lat, lng);
            }
        } else {
            console.error(`No results found for address: "${address}"`); // Log if no results
            alert("Address not found!");
        }
    });
}

</script>
</body>
</html>

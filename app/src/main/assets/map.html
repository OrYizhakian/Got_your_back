<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with GeoCoder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map-wrapper {
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .filter-button {
            position: absolute;
            left: 10px;
            top: 100px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .filter-control {
            position: absolute;
            left: 10px;
            top: 140px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid rgba(0,0,0,0.2);
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .filter-control.show {
            display: block;
        }
        .category-checkbox {
            display: block;
            margin: 5px 0;
        }
        .filter-control label {
            margin-left: 5px;
            font-size: 14px;
        }
        #selectAll {
            margin-bottom: 10px;
            padding: 5px;
            width: 100%;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<button class="filter-button" onclick="toggleFilterMenu()">Filter Categories</button>
<div class="filter-control" id="filterMenu">
    <button id="selectAll" onclick="toggleAll()">Select All</button>
    <label class="category-checkbox">
        <input type="checkbox" value="Restaurant" checked> Restaurant
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Coffee place" checked> Coffee place
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Beauty saloon" checked> Beauty saloon
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Grocery store" checked> Grocery store
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Clothes store" checked> Clothes store
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Book store" checked> Book store
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Gym" checked> Gym
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Pharmacy" checked> Pharmacy
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Hardware store" checked> Hardware store
    </label>
    <label class="category-checkbox">
        <input type="checkbox" value="Jewelry store" checked> Jewelry store
    </label>
</div>
<div id="map-wrapper">
    <div id="map"></div>
</div>

<script>
    let map;
    let markers = new Map();
    let isMapInitialized = false;
    let allBusinesses = [];
    let allSelected = true;

    // Define icons for each category
    const categoryIcons = {
        'Restaurant': 'fa-utensils',
        'Coffee place': 'fa-mug-hot',
        'Beauty saloon': 'fa-scissors',
        'Grocery store': 'fa-shopping-cart',
        'Clothes store': 'fa-tshirt',
        'Book store': 'fa-book',
        'Gym': 'fa-dumbbell',
        'Pharmacy': 'fa-prescription-bottle-medical',
        'Hardware store': 'fa-tools',
        'Jewelry store': 'fa-gem'
    };

    const categoryColors = {
        'Restaurant': '#e74c3c',
        'Coffee place': '#8b4513',
        'Beauty saloon': '#ff69b4',
        'Grocery store': '#2ecc71',
        'Clothes store': '#9b59b6',
        'Book store': '#3498db',
        'Gym': '#f39c12',
        'Pharmacy': '#1abc9c',
        'Hardware store': '#7f8c8d',
        'Jewelry store': '#f1c40f'
    };

    function createCustomIcon(category) {
    const iconClass = categoryIcons[category] || 'fa-store';
    const color = categoryColors[category] || '#3388ff';

    return L.divIcon({
        html: `
            <div style="
                width: 30px;
                height: 42px;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <div style="
                    width: 30px;
                    height: 30px;
                    background: ${color};
                    border-radius: 50% 50% 50% 0;
                    transform: rotate(-45deg);
                    position: absolute;
                    top: 5px;
                    left: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                ">
                    <i class="fa-solid ${iconClass}" style="
                        transform: rotate(45deg);
                        font-size: 14px;
                        color: white;
                    "></i>
                </div>
            </div>
        `,
        className: 'custom-icon',
        iconSize: [30, 42],
        iconAnchor: [15, 42],
        popupAnchor: [0, -42]
    });
}

    function initMap() {
        console.log('Initializing map...');
        try {
            map = L.map('map').setView([32.0853, 34.7818], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            document.querySelectorAll('.category-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', filterMarkers);
            });

            map.addEventListener('click', () => {
                document.getElementById('filterMenu').classList.remove('show');
            });

            isMapInitialized = true;
            if (window.Android && window.Android.onMapReady) {
                window.Android.onMapReady();
            }
        } catch (error) {
            console.error('Error initializing map:', error);
            if (window.Android && window.Android.onSearchError) {
                window.Android.onSearchError('Error initializing map: ' + error.message);
            }
        }
    }

    async function loadBusinesses(businesses, focusBusinessId) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
        document.getElementById('map-wrapper').appendChild(loadingOverlay);

        allBusinesses = businesses;
        markers.forEach(marker => map.removeLayer(marker.marker));
        markers.clear();

        try {
            const businessesToGeocode = [];
            const readyToDisplay = [];

            businesses.forEach(business => {
                if (business.latitude && business.longitude) {
                    readyToDisplay.push({
                        business,
                        coordinates: { lat: business.latitude, lon: business.longitude }
                    });
                } else {
                    businessesToGeocode.push(business);
                }
            });

            readyToDisplay.forEach(({ business, coordinates }) => {
                addMarkerToMap(business, coordinates, focusBusinessId);
            });

            if (businessesToGeocode.length > 0) {
                const geocodingPromises = businessesToGeocode.map(async (business) => {
                    try {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(business.address)}&limit=1`
                        );
                        const data = await response.json();

                        if (data && data.length > 0) {
                            const { lat, lon } = data[0];
                            if (window.Android && window.Android.saveBusinessCoordinates) {
                                window.Android.saveBusinessCoordinates(
                                    business.id,
                                    parseFloat(lat),
                                    parseFloat(lon)
                                );
                            }
                            return {
                                business,
                                coordinates: { lat: parseFloat(lat), lon: parseFloat(lon) }
                            };
                        }
                        return null;
                    } catch (error) {
                        console.error(`Error geocoding business ${business.id}:`, error);
                        return null;
                    }
                });

                const geocodedResults = await Promise.all(geocodingPromises);
                geocodedResults.forEach(result => {
                    if (result) {
                        addMarkerToMap(result.business, result.coordinates, focusBusinessId);
                    }
                });
            }

            if (!focusBusinessId && markers.size > 0) {
                const bounds = L.latLngBounds(
                    Array.from(markers.values()).map(m => [m.lat, m.lon])
                );
                map.fitBounds(bounds);
            }
        } catch (error) {
            console.error('Error loading businesses:', error);
        } finally {
            loadingOverlay.remove();
        }
    }

    function addMarkerToMap(business, coordinates, focusBusinessId) {
        const customIcon = createCustomIcon(business.category);
        const marker = L.marker([coordinates.lat, coordinates.lon], { icon: customIcon })
            .bindPopup(`
                <b>${business.name}</b><br>
                ${business.category}<br>
                ${business.address}
            `)
            .addTo(map);

        markers.set(business.id, {
            marker,
            lat: coordinates.lat,
            lon: coordinates.lon
        });

        if (business.id === focusBusinessId) {
            map.setView([coordinates.lat, coordinates.lon], 17);
            marker.openPopup();
        }
    }

    function toggleFilterMenu() {
        document.getElementById('filterMenu').classList.toggle('show');
    }

    function toggleAll() {
        allSelected = !allSelected;
        document.querySelectorAll('.category-checkbox input').forEach(checkbox => {
            checkbox.checked = allSelected;
        });
        document.getElementById('selectAll').textContent = allSelected ? 'Unselect All' : 'Select All';
        filterMarkers();
    }

    function filterMarkers() {
        const selectedCategories = Array.from(document.querySelectorAll('.category-checkbox input:checked'))
            .map(checkbox => checkbox.value);
        const bounds = [];

        markers.forEach((markerInfo, id) => {
            const business = allBusinesses.find(b => b.id === id);
            if (!business) return;

            const shouldShow = selectedCategories.includes(business.category);
            const marker = markerInfo.marker;

            if (shouldShow) {
                marker.addTo(map);
                bounds.push([markerInfo.lat, markerInfo.lon]);
            } else {
                marker.remove();
            }
        });

        if (bounds.length > 0) {
            map.fitBounds(bounds);
        }
    }

    window.onload = initMap;

    function onWebViewReady() {
        if (!isMapInitialized) {
            initMap();
        }
    }
</script>
</body>
</html>